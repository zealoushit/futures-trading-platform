# 📊 API测试工具使用指南

## 🚀 快速开始

### 打开测试工具
1. 双击 `api-test.html` 文件
2. 或在浏览器中输入：`file:///C:/Users/Administrator/IdeaProjects/untitled/api-test.html`

## 🔧 已修复的问题

### ✅ 1. 合约代码参数格式错误
**问题**: 订阅合约时总是报"合约代码参数格式错误"

**解决方案**:
- 修复了后端参数解析逻辑，支持多种格式：
  - 字符串：`"rb2405"`
  - 字符串数组：`["rb2405", "cu2405"]`
  - 字符串列表：JavaScript数组自动转换

**测试方法**:
```javascript
// 现在支持这些格式
{ "instruments": "rb2405" }                    // 单个合约
{ "instruments": ["rb2405", "cu2405"] }        // 多个合约
{ "instruments": "rb2405,cu2405" }             // 逗号分隔（前端自动处理）
```

### ✅ 2. 投资者ID配置
**问题**: 查询服务需要绑定投资者，测试页面没有输入的地方

**解决方案**:
- 新增"配置管理"面板
- 添加投资者ID设置功能
- 提供设置和获取投资者ID的API接口

**新增接口**:
- `POST /api/trading/config/investor` - 设置投资者ID
- `GET /api/trading/config/investor` - 获取当前投资者ID

### ✅ 3. 实时行情监控
**问题**: 需要加入对行情监控的实时展示

**解决方案**:
- 新增"实时行情监控"面板
- 美观的行情卡片展示
- 实时价格变化和涨跌幅计算
- 完整的五档买卖盘显示
- 成交量、持仓量等详细信息

## 🎯 功能面板介绍

### 1. ⚙️ 配置管理面板
- **投资者ID设置**: 输入并设置投资者ID
- **状态控制**: 获取状态、登录、登出
- **用途**: 为查询功能提供必要的用户身份信息

### 2. 📊 交易操作面板
- **下单功能**: 合约代码、买卖方向、开平标志、价格、数量
- **撤单功能**: 报单引用、前置编号、会话编号
- **查询功能**: 持仓、资金、报单、成交查询

### 3. 📈 行情操作面板
- **行情登录**: 独立的行情服务登录
- **订阅管理**: 订阅/退订行情，支持多合约
- **控制功能**: 清空行情数据

### 4. 📊 实时行情监控面板
- **行情卡片**: 每个合约独立的行情卡片
- **实时更新**: 自动更新行情数据，带动画效果
- **详细信息**: 价格、涨跌幅、成交量、五档买卖盘
- **控制功能**: 暂停/恢复更新

### 5. 📝 操作日志面板
- **实时日志**: 所有API调用和响应记录
- **WebSocket消息**: 实时推送消息显示
- **清空功能**: 清空日志记录

## 🎮 使用流程

### 基础配置流程
1. **设置投资者ID**: 在配置管理面板输入投资者ID并点击"设置投资者ID"
2. **连接服务**: 点击"获取状态"检查服务连接
3. **用户登录**: 点击"登录"进行交易登录
4. **行情登录**: 点击"行情登录"进行行情服务登录

### 交易测试流程
1. **下单测试**:
   - 输入合约代码（如：rb2405）
   - 选择买卖方向（买/卖）
   - 选择开平标志（开仓/平仓/平今）
   - 输入价格和数量
   - 点击"下单"

2. **查询测试**:
   - 点击"查询持仓"查看持仓信息
   - 点击"查询资金"查看资金账户
   - 点击"查询报单"查看报单记录
   - 点击"查询成交"查看成交记录

### 行情测试流程
1. **订阅行情**:
   - 在"订阅合约"输入框输入合约代码（支持多个，用逗号分隔）
   - 点击"订阅行情"
   - 观察实时行情监控面板的数据更新

2. **行情监控**:
   - 查看行情卡片的实时数据更新
   - 观察价格变化和涨跌幅计算
   - 查看五档买卖盘信息
   - 使用"暂停更新"/"恢复更新"控制显示

## 📋 行情卡片详解

### 卡片结构
```
┌─────────────────────────────────┐
│ rb2405                09:30:05  │ ← 合约代码和更新时间
├─────────────────────────────────┤
│           3500.00               │ ← 最新价
│        +10.00 (+0.29%)          │ ← 涨跌和涨跌幅
├─────────────────────────────────┤
│ 成交量: 12,345  成交额: 4,322万  │ ← 成交信息
│ 持仓量: 98,765  涨停价: 3,850   │ ← 持仓和价格信息
│ 跌停价: 3,150   昨收价: 3,450   │
├─────────────────────────────────┤
│ 买量 | 买价  | 卖价  | 卖量     │ ← 五档买卖盘
│  100 | 3499  | 3500  | 120     │
│  200 | 3498  | 3501  | 180     │
│  150 | 3497  | 3502  | 160     │
└─────────────────────────────────┘
```

### 颜色说明
- **红色**: 上涨价格和买盘价格
- **绿色**: 下跌价格和卖盘价格
- **蓝色**: 最新价格
- **绿色边框**: 数据更新时的闪烁效果

## 🔍 调试技巧

### 1. 查看网络请求
- 打开浏览器开发者工具（F12）
- 切换到"Network"标签
- 观察API请求和响应

### 2. 查看WebSocket连接
- 在开发者工具的"Network"标签中查看WS连接
- 观察WebSocket消息的发送和接收

### 3. 查看控制台日志
- 在开发者工具的"Console"标签中查看JavaScript日志
- 所有操作都会在页面的操作日志面板中显示

## ⚠️ 注意事项

### 1. 服务状态
- 如果Java服务未启动，所有API调用会失败
- 这是正常的，可以用来测试错误处理

### 2. 数据格式
- 价格输入支持小数
- 数量必须是正整数
- 合约代码区分大小写

### 3. 浏览器兼容性
- 推荐使用Chrome或Edge浏览器
- 确保JavaScript已启用

### 4. 实时更新
- 行情数据每秒更新一次（模拟模式）
- 可以使用"暂停更新"功能停止刷新
- 清空行情数据会重置所有历史价格

## 🎯 测试建议

### 完整测试流程
1. **基础功能测试**:
   - 设置投资者ID
   - 测试登录功能
   - 验证状态获取

2. **交易功能测试**:
   - 测试下单功能
   - 测试查询功能
   - 观察报单和成交回报

3. **行情功能测试**:
   - 测试行情订阅
   - 观察实时数据更新
   - 测试多合约同时订阅

4. **异常情况测试**:
   - 测试无效参数
   - 测试网络断开情况
   - 测试重复操作

现在您可以享受功能完整、界面美观的API测试工具了！🚀
